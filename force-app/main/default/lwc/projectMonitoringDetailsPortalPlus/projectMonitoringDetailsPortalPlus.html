<template>
    <c-show-toastr></c-show-toastr>

    <div class="app-main flex-column flex-row-fluid" id="kt_app_main">
        <div class="d-flex flex-column flex-column-fluid">
            <div id="kt_app_content" class="app-content">
                <div class="container-xxl">

                    <!-- Section Header -->
                    <div
                        class="app-content-menu menu menu-rounded menu-gray-800 menu-state-bg flex-wrap fs-5 fw-semibold border-bottom pt-5 pb-6 px-10 mb-10">
                        <div class="d-flex justify-content-between align-items-center w-100">
                            <div class="d-flex align-items-center gap-3">
                                <h1 lwc:if={previousTask} class="text-dark fw-bolder fs-2">{previousTask.accountName}</h1>
                                <h1 lwc:else class="text-dark fw-bolder fs-2">Project Monitoring</h1>
                            </div>
                            <template lwc:if={managerSelected}>
                                <div class="d-flex align-items-center gap-3">
                                    <button class="btn btn-primary" onclick={handleChangeManager}>
                                        <i class="bi bi-person-gear me-2"></i>Change Project Manager
                                    </button>
                                    
                                    <!-- Enhanced Filter Card -->
                                    <div class="card border-light-primary shadow-sm">
                                        <div class="card-body p-3">
                                            <div class="d-flex align-items-center gap-2">
                                                <i class="bi bi-funnel text-primary"></i>
                                                <label class="form-label fw-semibold text-primary mb-0 me-2">Filter:</label>
                                                <select class="form-select form-select-sm border-primary" 
                                                        onchange={handleStatusFilterChange}
                                                        style="min-width: 180px;">
                                                    <template for:each={statusFilterOptions} for:item="opt">
                                                        <option key={opt.value} value={opt.value} selected={opt.selected}>
                                                            {opt.label}
                                                        </option>
                                                    </template>
                                                </select>
                                                <span lwc:if={isLoading} class="spinner-border spinner-border-sm text-primary ms-2" role="status">
                                                    <span class="visually-hidden">Loading...</span>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </template>
                        </div>
                    </div>

                    <!-- Project Manager Selection Card -->
                    <div lwc:if={isSelectManager} class="row gx-5 gx-xl-10">
                        <div class="col-xxl-12 mb-5">
                            <div class="card card-flush">
                                <div class="w-100">
                                    <div class="pb-10">
                                        <h2 class="fw-bold text-gray-900 fs-1">Select a Project Manager</h2>
                                        <div class="text-muted fw-semibold fs-6">
                                            Please choose a Project Manager to view associated projects and begin
                                            monitoring.
                                        </div>
                                    </div>
                                    <!-- Enhanced Radio Options with Statistics -->
                                    <div class="fv-row">
                                        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
                                            <template for:each={projectManagers} for:item="item">
                                                <div class="col" key={item.value}>
                                                    <input type="radio" id={item.value} name="framework"
                                                        value={item.value} class="btn-check validate"
                                                        onchange={handleProjectManagerChange} checked={item.checked} />
                                    <label
                                        class="btn btn-outline btn-outline-dashed btn-active-light-primary p-4 d-flex flex-column w-100 h-100 position-relative"
                                        for={item.value}
                                        style="min-height: 200px;"
                                        data-completed={item.allUpdated}
                                        data-needs-attention={item.needsAttention}>                                                        <!-- Status Icon -->
                                                        <div class="position-absolute top-0 end-0 m-2">
                                                            <i class="bi {item.statusIcon} {item.statusColor} fs-3" 
                                                                title={item.statusText}></i>
                                                        </div>
                                                        
                                                        <!-- Manager Info -->
                                                        <div class="text-center flex-grow-1 d-flex flex-column justify-content-center">
                                                            <!-- Manager Name -->
                                                            <div class="mb-3">
                                                                <h6 class="text-gray-700 fw-bold mb-1">{item.label}</h6>
                                                                <template lwc:if={item.designation}>
                                                                    <span class="badge bg-light-secondary text-secondary fs-7">{item.designation}</span>
                                                                </template>
                                                            </div>
                                                            
                                                            <!-- Project Statistics -->
                                                            <div class="mt-auto">
                                                                <div class="row g-2 text-center">
                                                                    <div class="col-6">
                                                                        <div class="bg-light-primary rounded p-2">
                                                                            <div class="fs-3 fw-bold text-primary">{item.totalProjects}</div>
                                                                            <div class="fs-8 text-muted">Total Projects</div>
                                                                        </div>
                                                                    </div>
                                                                    <div class="col-6">
                                                                        <div class="bg-light-success rounded p-2">
                                                                            <div class="fs-3 fw-bold text-success">{item.updatedToday}</div>
                                                                            <div class="fs-8 text-muted">Updated Today</div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                
                                                                <!-- Progress Indicator -->
                                                                <template lwc:if={item.totalProjects}>
                                                                    <div class="mt-3">
                                                                        <div class="d-flex justify-content-between align-items-center mb-1">
                                                                            <small class="text-muted">Progress</small>
                                                                            <small class="fw-bold">{item.progressPercentage}%</small>
                                                                        </div>
                                                                        <div class="progress" style="height: 8px;">
                                                                            <div class="progress-bar bg-success" 
                                                                                role="progressbar" 
                                                                                aria-valuenow={item.progressPercentage} 
                                                                                aria-valuemin="0" 
                                                                                aria-valuemax="100"
                                                                                onload={setProgressWidth}>
                                                                            </div>
                                                                        </div>
                                                                        <div class="text-center mt-1">
                                                                            <span class="fs-8 text-muted">
                                                                                {item.updatedToday} of {item.totalProjects} projects
                                                                            </span>
                                                                        </div>
                                                                    </div>
                                                                </template>
                                                                
                                                                <!-- Status Badge -->
                                                                <div class="mt-2">
                                                                    <span class="badge {item.statusBadgeClass} fs-7">
                                                                        <i class="bi {item.statusIcon} me-1"></i>
                                                                        {item.statusText}
                                                                    </span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </template>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task Detail View -->
                    <template lwc:if={showTaskCards}>
                        <!-- Filter Status Indicator -->
                        <div class="row gx-5 gx-xl-10 mb-4">
                            <div class="col-12">
                                <div class="card border-0 bg-light-primary">
                                    <div class="card-body p-3">
                                        <div class="d-flex align-items-center justify-content-between">
                                            <div class="d-flex align-items-center">
                                                <i class="bi {filterDisplayInfo.icon} text-{filterDisplayInfo.color} fs-4 me-3"></i>
                                                <div>
                                                    <h5 class="text-{filterDisplayInfo.color} fw-bold mb-0">
                                                        {selectedStatusFilter} Filter Active
                                                    </h5>
                                                    <p class="text-muted mb-0 fs-7">{filterDisplayInfo.description}</p>
                                                </div>
                                            </div>
                                            <div class="text-end">
                                                <div class="badge badge-light-{filterDisplayInfo.color} fs-6">
                                                    {projectCountDisplay}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row gx-5 gx-xl-10">
                            <!-- Project Details -->
                            <div class="col-xxl-4 mb-5">
                                <div class="card card-flush h-xl-100 shadow">
                                    <div class={priorityCardClass}>
                                        <div class="card-title">
                                            <h2 class="fw-bold text-primary">Project Details</h2>
                                        </div>
                                    </div>
                                    <div class="card-body pt-0">
                                        <div class="mb-4">
                                            <p class="fw-bold text-gray-800 fs-6 mb-2">
                                                <i class="bi bi-diagram-3 text-primary me-2"></i>
                                                <strong>Project:</strong> {previousTask.opportunityName}
                                            </p>
                                        </div>
                                        
                                        <!-- Enhanced Project Status Card -->
                                        <div class="card border-light-secondary mb-4">
                                            <div class="card-header bg-light-secondary">
                                                <h6 class="card-title text-dark fw-bold mb-0">
                                                    <i class="bi bi-gear me-2"></i>Project Status
                                                </h6>
                                            </div>
                                            <div class="card-body">
                                                <select class="form-select border-secondary" 
                                                        onchange={handleProjectStatusChange}
                                                        disabled={viewOnlyMode}>
                                                    <template for:each={mappedProjectStatusOptions} for:item="opt">
                                                        <option key={opt.value} value={opt.value} selected={opt.selected}>
                                                            {opt.label}
                                                        </option>
                                                    </template>
                                                </select>
                                            </div>
                                        </div>
                                        <template lwc:if={previousTask.clientOnboardingSheet}>
                                            <p><strong>Client Onboarding Sheet:</strong>
                                                <button class="btn btn-link p-0 text-decoration-none" 
                                                        onclick={openClientOnboardingModal}>
                                                    <i class="bi bi-file-earmark-excel text-success me-1"></i>View Sheet
                                                </button>
                                            </p>
                                        </template>

                                        <template lwc:if={previousTask.projectTracker}>
                                            <p><strong>Project Tracker:</strong>
                                                <button class="btn btn-link p-0 text-decoration-none" 
                                                        onclick={openProjectTrackerModal}>
                                                    <i class="bi bi-file-earmark-spreadsheet text-info me-1"></i>View Sheet
                                                </button>
                                            </p>
                                        </template>
                                    </div>
                                </div>
                            </div>

                            <!-- Actions and Goals -->
                            <div class="col-xxl-8 mb-5">
                                <!-- Previous Actions -->
                                <template lwc:if={showPreviousActions}>
                                    <div class="card card-flush shadow">
                                        <div class="card-header bg-light-success">
                                            <div class="card-title">
                                                <h2 class="fw-bold text-success">Previous Actions</h2>
                                            </div>
                                        </div>
                                        <div class="card-body pt-0">
                                            <div class="row g-3">
                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Previous Day Date</label>
                                                    <div class="form-control-plaintext">
                                                        <template lwc:if={previousDayDate}>
                                                            <lightning-formatted-date-time
                                                                value={previousDayDate}
                                                                year="numeric"
                                                                month="short"
                                                                day="2-digit"
                                                                hour="2-digit"
                                                                minute="2-digit">
                                                            </lightning-formatted-date-time>
                                                        </template>
                                                        <template lwc:else>
                                                            <span class="text-muted">N/A</span>
                                                        </template>
                                                    </div>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Last Meeting Date</label>
                                                    <div class="form-control-plaintext">
                                                        <template lwc:if={lastMeetingDate}>
                                                            <lightning-formatted-date-time
                                                                value={lastMeetingDate}
                                                                year="numeric"
                                                                month="short"
                                                                day="2-digit"
                                                                hour="2-digit"
                                                                minute="2-digit">
                                                            </lightning-formatted-date-time>
                                                        </template>
                                                        <template lwc:else>
                                                            <span class="text-muted">N/A</span>
                                                        </template>
                                                    </div>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Previous Day Action</label>
                                                    <textarea class="form-control" readonly>{previousStep}</textarea>
                                                </div>

                                                <div class="col-md-6">
                                                    <label class="form-label fw-semibold">Previous Day Agenda</label>
                                                    <textarea class="form-control" readonly>{previousAgenda}</textarea>
                                                </div>

                                                <div class="col-12" lwc:if={previousRiskAndAction}>
                                                    <label class="form-label fw-semibold">Previous Risk & Action</label>
                                                    <textarea class="form-control border border-danger"
                                                        style="box-shadow: 0 0 8px rgba(220,53,69,0.6);" readonly>{previousRiskAndAction}</textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>

                                <!-- Goals for Today / Support Fields -->
                                <template lwc:if={showTaskCards}>
                                    <div class="card card-flush mt-6 shadow">
                                        <div class="card-header bg-light-warning">
                                            <div class="card-title">
                                                <h2 lwc:if={isClosedOrGoLive} class="fw-bold text-warning">Follow Up Task
                                                </h2>
                                                <h2 lwc:else class="fw-bold text-warning">Goals for Today</h2>
                                            </div>
                                        </div>
                                        <div class="card-body pt-0">
                                            
                                            <!-- Meeting Details Sub-Card -->
                                            <div class="card border-light-info mb-4">
                                                <div class="card-header bg-light-info">
                                                    <h5 class="card-title text-info fw-bold mb-0">
                                                        <i class="bi bi-calendar-event me-2"></i>Meeting Details
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <!-- Next Meeting Scheduled / Follow-up Required -->
                                                    <div class="mb-3 position-relative">
                                                        <label class="form-label fw-semibold">{followUpRequiredLabel}</label>
                                                        <template lwc:if={viewOnlyMode}>
                                                            <template lwc:if={isEditingMeetingScheduled}>
                                                                <select class="form-select" data-field="nextMeetingScheduled" 
                                                                    onchange={handleNextMeetingScheduledChange} onblur={handleFieldBlur}>
                                                                    <template for:each={mappedMeetingScheduledOptions} for:item="opt">
                                                                        <option key={opt.value} value={opt.value} selected={opt.selected}>{opt.label}</option>
                                                                    </template>
                                                                </select>
                                                            </template>
                                                            <template lwc:else>
                                                                <div class="form-control bg-light border border-2 border-dashed position-relative" 
                                                                    data-field="nextMeetingScheduled" onclick={handleFieldClick} 
                                                                    style="cursor: pointer; min-height: 38px;">
                                                                    <span class={meetingScheduledDisplayClass}>{meetingScheduledDisplay}</span>
                                                                    <i class="bi bi-pencil-square position-absolute text-muted" 
                                                                        style="top: 8px; right: 8px; font-size: 14px;"></i>
                                                                </div>
                                                            </template>
                                                        </template>
                                                        <template lwc:else>
                                                            <select class="form-select" onchange={handleNextMeetingScheduledChange}>
                                                                <template for:each={mappedMeetingScheduledOptions} for:item="opt">
                                                                    <option key={opt.value} value={opt.value} selected={opt.selected}>{opt.label}</option>
                                                                </template>
                                                            </select>
                                                        </template>
                                                    </div>

                                                    <!-- Next Meeting Date for In Development follow-up -->
                                                    <template lwc:if={showInDevSupportFields}>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Next Meeting Date</label>
                                                            <c-flat-pickr-input value={currentNextMeetingDate} options={flatpickrOptions} onchange={handleNextMeetingDateChange} disabled={viewOnlyMode}></c-flat-pickr-input>
                                                        </div>
                                                    </template>

                                                    <!-- Post Go Live Support Date when support required -->
                                                    <template lwc:if={showGoLiveSupportFields}>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Post Go Live Support Start<span class="text-danger">*</span></label>
                                                            <c-flat-pickr-input value={currentNextMeetingDate} options={flatpickrOptions} onchange={handleNextMeetingDateChange} disabled={viewOnlyMode}></c-flat-pickr-input>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Post Go Live Support End<span class="text-danger">*</span></label>
                                                            <c-flat-pickr-input data-id="supportEnd" value={currentSupportEndDate} options={flatpickrOptions} onchange={handleSupportEndDateChange} disabled={viewOnlyMode}></c-flat-pickr-input>
                                                        </div>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Post Go Live Support Plan<span class="text-danger">*</span></label>
                                                            <lightning-input-rich-text value={currentSupportPlan} onchange={handleSupportPlanChange} disabled={viewOnlyMode}></lightning-input-rich-text>
                                                        </div>
                                                    </template>
                                                    
                                                    <!-- Closed Status Support Fields when follow-up required -->
                                                    <template lwc:if={showClosedSupportFields}>
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">{nextMeetingDateLabel}<span class="text-danger">*</span></label>
                                                            <c-flat-pickr-input value={currentNextMeetingDate} options={flatpickrOptions} onchange={handleNextMeetingDateChange} disabled={viewOnlyMode}></c-flat-pickr-input>
                                                        </div>
                                                    </template>

                                                    <!-- Meeting Agenda Fields -->
                                                    <template lwc:if={showClosedSupportFields}>
                                                        <div class="mb-3 position-relative">
                                                            <label class="form-label fw-semibold">{nextMeetingAgendaLabel}<span class="text-danger">*</span></label>
                                                            <template lwc:if={viewOnlyMode}>
                                                                <template lwc:if={isEditingAgenda}>
                                                                    <textarea class="form-control" data-field="nextAgenda" 
                                                                        onchange={handleAgendaChange} onblur={handleFieldBlur}>{currentAgenda}</textarea>
                                                                </template>
                                                                <template lwc:else>
                                                                    <div class="form-control bg-light border border-2 border-dashed position-relative" 
                                                                        data-field="nextAgenda" onclick={handleFieldClick} 
                                                                        style="cursor: pointer; min-height: 38px;">
                                                                        <span class={agendaDisplayClass}>{agendaDisplay}</span>
                                                                        <i class="bi bi-pencil-square position-absolute text-muted" 
                                                                            style="top: 8px; right: 8px; font-size: 14px;"></i>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template lwc:else>
                                                                <textarea class="form-control" onchange={handleAgendaChange}>{currentAgenda}</textarea>
                                                            </template>
                                                        </div>
                                                    </template>

                                                    <!-- New Next Steps widget when not Closed/Go Live -->
                                                    <template lwc:if={showNextAgendaField}>
                                                        <div class="mb-3 position-relative">
                                                            <label class="form-label fw-semibold">Next Meeting Agenda</label>
                                                            <template lwc:if={viewOnlyMode}>
                                                                <template lwc:if={isEditingAgenda}>
                                                                    <textarea class="form-control" data-field="nextAgenda" 
                                                                        onchange={handleAgendaChange} onblur={handleFieldBlur}>{currentAgenda}</textarea>
                                                                </template>
                                                                <template lwc:else>
                                                                    <div class="form-control bg-light border border-2 border-dashed position-relative" 
                                                                        data-field="nextAgenda" onclick={handleFieldClick} 
                                                                        style="cursor: pointer; min-height: 38px;">
                                                                        <span class={agendaDisplayClass}>{agendaDisplay}</span>
                                                                        <i class="bi bi-pencil-square position-absolute text-muted" 
                                                                            style="top: 8px; right: 8px; font-size: 14px;"></i>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template lwc:else>
                                                                <textarea class="form-control" onchange={handleAgendaChange}>{currentAgenda}</textarea>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>

                                            <!-- Project Progress Sub-Card -->
                                            <div class="card border-light-success mb-4 mt-4">
                                                <div class="card-header bg-light-success">
                                                    <h5 class="card-title text-success fw-bold mb-0">
                                                        <i class="bi bi-arrow-right-circle me-2"></i>Project Progress
                                                    </h5>
                                                </div>
                                                <div class="card-body">
                                                    <!-- In Development: Next Steps -->
                                                    <template lwc:if={showNextStepsField}>
                                                        <div class="mb-3 position-relative">
                                                            <label class="form-label fw-semibold">Next Steps</label>
                                                            <template lwc:if={viewOnlyMode}>
                                                                <template lwc:if={isEditingNextSteps}>
                                                                    <textarea class="form-control" data-field="nextSteps" 
                                                                        onchange={handleNextStepsChange} onblur={handleFieldBlur}>{newNextSteps}</textarea>
                                                                </template>
                                                                <template lwc:else>
                                                                    <div class="form-control bg-light border border-2 border-dashed position-relative" 
                                                                        data-field="nextSteps" onclick={handleFieldClick} 
                                                                        style="cursor: pointer; min-height: 38px;">
                                                                        <span class={nextStepsDisplayClass}>{nextStepsDisplay}</span>
                                                                        <i class="bi bi-pencil-square position-absolute text-muted" 
                                                                            style="top: 8px; right: 8px; font-size: 14px;"></i>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template lwc:else>
                                                                <textarea class="form-control" onchange={handleNextStepsChange}>{newNextSteps}</textarea>
                                                            </template>
                                                        </div>
                                                    </template>
                                                    
                                                    <!-- Risk & Action field (required for In Development, optional for Closed) -->
                                                    <template lwc:if={showRiskAndActionField}>
                                                        <div class="mb-3 position-relative">
                                                            <label class="form-label fw-semibold">Risk & Action</label>
                                                            <template lwc:if={viewOnlyMode}>
                                                                <template lwc:if={isEditingRiskAndAction}>
                                                                    <input type="text" class="form-control" data-field="riskAndAction" 
                                                                        value={currentRiskAndAction} onchange={handleRiskAndActionChange} onblur={handleFieldBlur}/>
                                                                </template>
                                                                <template lwc:else>
                                                                    <div class="form-control bg-light border border-2 border-dashed position-relative" 
                                                                        data-field="riskAndAction" onclick={handleFieldClick} 
                                                                        style="cursor: pointer; min-height: 38px;">
                                                                        <span class={riskActionDisplayClass}>{riskActionDisplay}</span>
                                                                        <i class="bi bi-pencil-square position-absolute text-muted" 
                                                                            style="top: 8px; right: 8px; font-size: 14px;"></i>
                                                                    </div>
                                                                </template>
                                                            </template>
                                                            <template lwc:else>
                                                                <input type="text" class="form-control" value={currentRiskAndAction} onchange={handleRiskAndActionChange}/>
                                                            </template>
                                                        </div>
                                                    </template>
                                                </div>
                                            </div>

                                            <!-- Reason Fields (outside of sub-cards since they're conditional and replace other fields) -->
                                            <template lwc:if={showReasonField}>
                                                <div class="card border-light-warning mb-4 mt-4">
                                                    <div class="card-header bg-light-warning">
                                                        <h5 class="card-title text-warning fw-bold mb-0">
                                                            <i class="bi bi-exclamation-triangle me-2"></i>Reason for No Follow-up
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Reason</label>
                                                            <textarea class="form-control" disabled={viewOnlyMode} onchange={handleReasonChange} placeholder="Enter reason...">{currentReason}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Go Live specific reason when no support -->
                                            <template lwc:if={showGoLiveReasonField}>
                                                <div class="card border-light-warning mb-4 mt-4">
                                                    <div class="card-header bg-light-warning">
                                                        <h5 class="card-title text-warning fw-bold mb-0">
                                                            <i class="bi bi-exclamation-triangle me-2"></i>Reason for No Support
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Reason</label>
                                                            <textarea class="form-control" disabled={viewOnlyMode} onchange={handleReasonChange} placeholder="Enter reason...">{currentReason}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>
                                            
                                            <!-- Closed status specific reason when no follow-up required -->
                                            <template lwc:if={showClosedReasonField}>
                                                <div class="card border-light-warning mb-4 mt-4">
                                                    <div class="card-header bg-light-warning">
                                                        <h5 class="card-title text-warning fw-bold mb-0">
                                                            <i class="bi bi-exclamation-triangle me-2"></i>Reason for No Follow-up
                                                        </h5>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="mb-3">
                                                            <label class="form-label fw-semibold">Reason</label>
                                                            <textarea class="form-control" disabled={viewOnlyMode} onchange={handleReasonChange} placeholder="Enter reason...">{currentReason}</textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </template>

                                            <!-- Save / Navigation -->
                                            <div class="d-flex justify-content-between mt-4">
                                                <div>
                                                    <button class="btn btn-outline-secondary me-2"
                                                        onclick={handlePrevious}>Previous</button>
                                                </div>
                                                <div lwc:if={viewOnlyMode}>
                                                    <template lwc:if={showSaveButton}>
                                                        <button class="btn btn-success px-4 fw-semibold me-2"
                                                            onclick={handleInlineSave} disabled={isSavingField}>
                                                            <template lwc:if={isSavingField}>
                                                                <span class="spinner-border spinner-border-sm me-1" role="status"></span>
                                                                Saving...
                                                            </template>
                                                            <template lwc:else>
                                                                Save
                                                            </template>
                                                        </button>
                                                        <button class="btn btn-outline-secondary px-4 fw-semibold"
                                                            onclick={handleInlineCancel} disabled={isSavingField}>Cancel</button>
                                                    </template>
                                                    <template lwc:else>
                                                        <button class="btn btn-primary px-4 fw-semibold"
                                                            onclick={handleSkip}>Next</button>
                                                    </template>
                                                </div>
                                                <div lwc:else>
                                                    <button class="btn btn-primary px-4 fw-semibold"
                                                        onclick={handleSaveAndNext}>Save & Next</button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </template>
                            </div>
                        </div>
                    </template>

                    <!-- Modal for Follow-Up Task -->
                    <template lwc:if={showTaskModal}>
                        <section class="modal fade show d-block" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Create Follow-Up Task</h5>
                                        <button type="button" class="btn-close" onclick={closeTaskModal}></button>
                                    </div>
                                    <div class="modal-body">
                                        <p>This project status indicates a closing or go-live stage. You may want to
                                            create a new follow-up task.</p>
                                    </div>
                                    <div class="modal-footer">
                                        <button type="button" class="btn btn-secondary"
                                            onclick={closeTaskModal}>Close</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </template>
                    <!-- Confirmation for no post-go-live support -->
                    <template lwc:if={showConfirmNoSupportModal}>
                        <section class="modal fade show d-block" tabindex="-1" role="dialog">
                            <div class="modal-dialog modal-dialog-centered">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">Confirm No Support</h5>
                                        <button type="button" class="btn-close" onclick={confirmNoSupportNo}></button>
                                    </div>
                                    <div class="modal-body">
                                        <template lwc:if={isClosedStatus}>
                                            <p>Thank you for your outstanding work on this project. Would you be willing to take the lead on future follow-ups with the customer?</p>
                                        </template>
                                        <template lwc:else>
                                            <p>Are you sure this project does not require the standard two-week post–go-live support?</p>
                                        </template>
                                    </div>
                                    <div class="modal-footer">
                                        <button class="btn btn-primary" onclick={confirmNoSupportYes}>Yes</button>
                                        <button class="btn btn-secondary" onclick={confirmNoSupportNo}>No</button>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </template>

                    <!-- Enhanced no projects message for Review mode -->
                    <template lwc:if={noTasksError}>
                        <template lwc:if={viewOnlyMode}>
                            <!-- Enhanced Review Mode Message -->
                            <div class="row gx-5 gx-xl-10 mt-5">
                                <div class="col-12">
                                    <div class="card border-0 bg-light-warning">
                                        <div class="card-body p-4 text-center">
                                            <div class="mb-4">
                                                <i class="bi bi-search text-warning" style="font-size: 3rem;"></i>
                                            </div>
                                            <h4 class="text-warning fw-bold mb-3">{noProjectsMessage.title}</h4>
                                            <p class="text-muted mb-4 fs-6">{noProjectsMessage.message}</p>
                                            
                                            <!-- Filter Suggestions -->
                                            <template lwc:if={noProjectsMessage.suggestions}>
                                                <template lwc:if={noProjectsMessage.suggestions.length}>
                                                    <div class="mb-3">
                                                        <p class="fw-semibold mb-2">Try these filters:</p>
                                                        <div class="d-flex justify-content-center gap-2 flex-wrap">
                                                            <template for:each={noProjectsMessage.suggestions} for:item="suggestion">
                                                                <button key={suggestion} 
                                                                    class="btn btn-outline-warning btn-sm" 
                                                                    data-filter={suggestion}
                                                                    onclick={handleSuggestionClick}>
                                                                    {suggestion}
                                                                </button>
                                                            </template>
                                                        </div>
                                                    </div>
                                                </template>
                                            </template>
                                            
                                            <!-- Additional Help -->
                                            <div class="mt-4 pt-3 border-top border-warning">
                                                <p class="text-muted fs-7 mb-2">
                                                    <i class="bi bi-lightbulb me-1"></i>
                                                    <strong>Tip:</strong> Use the filter dropdown above to explore different project views
                                                </p>
                                                <p class="text-muted fs-7 mb-0">
                                                    <i class="bi bi-arrow-clockwise me-1"></i>
                                                    You can also try changing the Project Manager to see other projects
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <template lwc:else>
                            <!-- Standard Update Mode Message -->
                            <div class="alert alert-info mt-5" role="alert">
                                No Projects currently meet the selected criteria. Please refine your filters or check again later.
                            </div>
                        </template>
                    </template>

                    <template lwc:if={managerSelected}>
                        <template lwc:if={noTasksError}>
                            <!-- no cards when noTasksError -->
                        </template>
                        <template lwc:else>
                            <!-- existing layout with cards -->
                            <template lwc:if={showTaskCards}>
                                <!-- ...existing Task Detail View... -->
                            </template>
                        </template>
                    </template>
                </div>
            </div>
        </div>
    </div>

    <template lwc:if={showModeSelectModal}>
        <section class="modal fade show d-block" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Choose Action</h5>
                        <button type="button" class="btn-close" onclick={closeModeSelectModal}></button>
                    </div>
                    <div class="modal-body">
                        <p>How would you like to proceed with the selected Project Manager?</p>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-outline-primary" onclick={handleViewMode}>Review Projects</button>
                        <button class="btn btn-primary" onclick={handleUpdateMode}>Update</button>
                    </div>
                </div>
            </div>
        </section>
    </template>

    <!-- Master-detail UI -->
    <!-- Removed extra master-detail block to restore original card layout -->

    <!-- Warning Modal -->
    <template if:true={showWarningModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-modal__title">Warning</h2>
                </header>
                <div class="slds-modal__content">{warningMessage}</div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Close" onclick={closeWarningModal}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Block Modal -->
    <template if:true={showBlockModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <h2 class="slds-modal__title">Error</h2>
                </header>
                <div class="slds-modal__content">{blockMessage}</div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Close" onclick={closeBlockModal}></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>

    <!-- Document Modal -->
    <template lwc:if={showDocumentModal}>
        <section role="dialog" tabindex="-1" class="slds-modal slds-fade-in-open slds-modal_large">
            <div class="slds-modal__container">
                <header class="slds-modal__header">
                    <button class="slds-button slds-button_icon slds-modal__close slds-button_icon-inverse"
                            title="Close" onclick={closeDocumentModal}>
                        <lightning-icon icon-name="utility:close" alternative-text="close" size="small"></lightning-icon>
                        <span class="slds-assistive-text">Close</span>
                    </button>
                    <h2 class="slds-modal__title slds-hyphenate">
                        <i class={modalDocumentIcon}></i>
                        {modalTitle}
                    </h2>
                </header>
                <div class="slds-modal__content slds-var-p-around_medium" style="height: 70vh;">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-info">Document Preview</span>
                            <small class="text-muted">{documentTypeMessage}</small>
                        </div>
                        <a href={currentDocumentUrl} target="_blank" class="btn btn-outline-primary btn-sm">
                            <i class="bi bi-box-arrow-up-right me-1"></i>Open in New Tab
                        </a>
                    </div>
                    
                    <!-- Excel/Google Sheets Preview -->
                    <template lwc:if={isExcelOrSheets}>
                        <iframe 
                            src={embedUrl} 
                            style="width: 100%; height: 100%; border: 1px solid #ddd; border-radius: 4px;"
                            title={modalTitle}>
                        </iframe>
                    </template>
                    
                    <!-- PDF Preview -->
                    <template lwc:if={isPdf}>
                        <iframe 
                            src={currentDocumentUrl} 
                            style="width: 100%; height: 100%; border: 1px solid #ddd; border-radius: 4px;"
                            title={modalTitle}>
                        </iframe>
                    </template>
                    
                    <!-- Other Document Types -->
                    <template lwc:if={isOtherDocument}>
                        <div class="text-center p-5">
                            <i class="bi bi-file-earmark-text" style="font-size: 4rem; color: #6c757d;"></i>
                            <h5 class="mt-3">Document Preview Not Available</h5>
                            <p class="text-muted">This document type cannot be previewed in the browser.</p>
                            <p class="text-muted">Please click "Open in New Tab" to view the document.</p>
                        </div>
                    </template>
                </div>
                <footer class="slds-modal__footer">
                    <lightning-button label="Close" onclick={closeDocumentModal}></lightning-button>
                    <lightning-button variant="brand" label="Open in New Tab" 
                                    onclick={openInNewTab} class="slds-var-m-left_x-small"></lightning-button>
                </footer>
            </div>
        </section>
        <div class="slds-backdrop slds-backdrop_open"></div>
    </template>
</template>